https://www.cnblogs.com/ll409546297/p/17129532.html  
目录结构  
![img.png](img%2Fimg.png)


#### 1.因为PXC在mysql8.0以上都是要求CA证书的，所以第一部建立证书

#### 使用openssl创建CA证书
openssl genrsa -out ca-key.pem
openssl req -new -x509 -nodes -key ca-key.pem -out ca.pem

#创建服务器证书
openssl req -newkey rsa:2048 -nodes -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem

#### 创建客户端证书
openssl req -newkey rsa:2048 -nodes -keyout client-key.pem -out client-req.pem
openssl rsa -in client-key.pem -out client-key.pem
openssl x509 -req -in client-req.pem -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out client-cert.pem

#### 验证
openssl verify -CAfile ca.pem server-cert.pem client-cert.pem

最后这样算是通过  
![img_1.png](img%2Fimg_1.png)  
如果存在一下错误  
![img_2.png](img%2Fimg_2.png)  
在填写信息的时候在common name写上自定义的名称  
![img_3.png](img%2Fimg_3.png)  
CA和（CLIENT,SERVER）名称不能一样。  


#### 2.ca的东西生成过后，需要建立配置cert.cnf(放在cert/config下)
[mysqld]
skip-name-resolve
ssl-ca = /cert/ca.pem
ssl-cert = /cert/server-cert.pem
ssl-key = /cert/server-key.pem

[client]
ssl-ca = /cert/ca.pem
ssl-cert = /cert/client-cert.pem
ssl-key = /cert/client-key.pem

[sst]
encrypt = 4
ssl-ca = /cert/ca.pem
ssl-cert = /cert/server-cert.pem
ssl-key = /cert/server-key.pem


#### 3.docker-compose部署
##### dockerfile,Dockerfile-pxc
FROM percona/percona-xtradb-cluster:8.0.19
MAINTAINER xbd
COPY ./cert /cert
COPY ./cert/conf /etc/percona-xtradb-cluster.conf.d

##### docker-compose.yml
refer to docker-compose-v8/pxc-v8.yml


#### 启动顺序，先启动1，然后在启动2,3
![img_4.png](img%2Fimg_4.png)

#### 4.考虑到集群方式，需要独立的连接方式，单独暴露等等。
1）方案存在keepalived、proxysql、haproxy等。
2）keepalived的主要是通过虚拟IP来访问，但是需要占用物理资源，对docker不友好。
3）proxysql很强大，也是后面的主流，但是配置麻烦，还得配置数据库，所以这里采用了haproxy
4）haproxy，配置简单，也有UI界面。这里也使用的docker方式部署，简单易用。
5）部署：
a.准备配置文件haproxy.cfg放在haproxy目录下
b.dockerfile,Dockerfile-haproxy

FROM haproxy:2.7.3
MAINTAINER xbd
USER haproxy
COPY ./haproxy/haproxy.cfg /usr/local/etc/haproxy/haproxy.cfg

c.docker-compose.yml完整版
version: "2"
services:
xbd-pxc-1:
build:
context: ./
dockerfile: ./Dockerfile-pxc
image: xbd-pxc
restart: always
container_name: xbd-pxc-1
volumes:
- /var/lib/mysql/xbd-pxc-1:/var/lib/mysql
ports:
- 3306:3306
environment:
- TZ=Asia/Shanghai
- MYSQL_ROOT_PASSWORD=root
- CLUSTER_NAME=xbd-pxc-cluster
privileged: true

xbd-pxc-2:
build:
context: ./
dockerfile: ./Dockerfile-pxc
image: xbd-pxc
restart: always
container_name: xbd-pxc-2
volumes:
- /var/lib/mysql/xbd-pxc-2:/var/lib/mysql
ports:
- 3307:3306
environment:
- TZ=Asia/Shanghai
- MYSQL_ROOT_PASSWORD=root
- CLUSTER_NAME=xbd-pxc-cluster
- CLUSTER_JOIN=xbd-pxc-1
privileged: true

xbd-pxc-3:
build:
context: ./
dockerfile: ./Dockerfile-pxc
image: xbd-pxc
restart: always
container_name: xbd-pxc-3
volumes:
- /var/lib/mysql/xbd-pxc-3:/var/lib/mysql
ports:
- 3308:3306
environment:
- TZ=Asia/Shanghai
- MYSQL_ROOT_PASSWORD=root
- CLUSTER_NAME=xbd-pxc-cluster
- CLUSTER_JOIN=xbd-pxc-1
privileged: true

xbd-pxc-haproxy:
build:
context: ./
dockerfile: ./Dockerfile-haproxy
image: xbd-pxc-haproxy
restart: always
container_name: xbd-pxc-haproxy
ports:
- 6033:3306
- 33066:33066
privileged: true


### 启动测试
![img_5.png](img%2Fimg_5.png)
